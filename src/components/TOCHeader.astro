---
import { ScrollArea } from '@/components/ui/scroll-area'
import { cn, getHeadingMargin } from '@/lib/utils'
import type { MarkdownHeading } from 'astro'
import { Icon } from 'astro-icon/components'

type Props = {
  headings: MarkdownHeading[]
}

const { headings } = Astro.props
---

{
  headings && headings.length > 0 && (
    <div id="mobile-toc-container" class="border-accent w-full xl:hidden">
      <details id="mobile-toc-details" class="group">
        <summary class="flex w-full items-center justify-between cursor-pointer list-none">
          <div class="mx-auto flex w-full max-w-3xl items-center px-4 py-3">
            <span class="text-muted-foreground flex-grow truncate text-sm">
              Table of Contents
            </span>
            <span class="text-muted-foreground ml-2">
              <Icon
                name="lucide:chevron-down"
                class="h-4 w-4 transition-transform duration-200 group-open:rotate-180"
              />
            </span>
          </div>
        </summary>

        <ScrollArea
          client:load
          className="mx-auto max-w-3xl"
        >
          <div class="max-h-[40vh] overflow-y-auto">
            <ul class="flex list-none flex-col gap-y-3 px-8 pb-6">
              {headings.map((heading) => (
                <li
                  class={cn(
                    'text-sm',
                    getHeadingMargin(heading.depth),
                  )}
                >
                  <a
                    href={`#${heading.slug}`}
                    class="mobile-toc-link text-foreground/70 hover:text-foreground transition-colors duration-200"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </ScrollArea>
      </details>
    </div>
  )
}

<script>
  function setupMobileTOC() {
    const details = document.getElementById(
      'mobile-toc-details',
    ) as HTMLDetailsElement | null
    if (!details) return

    // Close the dropdown when a link is clicked
    const links = details.querySelectorAll('.mobile-toc-link')
    links.forEach((link) => {
      link.addEventListener('click', () => {
        details.open = false
      })
    })
  }

  // Initialize on page load and after Astro transitions
  document.addEventListener('astro:page-load', setupMobileTOC)
</script>
